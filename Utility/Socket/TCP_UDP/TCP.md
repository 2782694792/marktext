# TCP 协议

- TCP (Transmission Control Protocol，传输控制协议)，提供IP环境下的数据可靠传输；

- 服务支持：包括数据流传送、**可靠**性、有效流控、全双工操作和多路复用；

- 通过**面向连接**、端到端和可靠的数据包发送；

- TCP 是一种面向流的协议，意味着当进程向其他进程发送数据时，该数据是一串无界的字符流。

## 1.1 协议族

TCP/IP是基于 TCP 和 IP 这两个最初的协议之上的不同的通信协议的大集合；

<img src="../../../image%20cache/TCPIP%20协议族.png" title="" alt="" data-align="center">

## 1.2 协议的分层

<img src="../../../image%20cache/协议的分层.png" title="" alt="" data-align="center">

## 1.3 分层的作用

<img src="../../../image%20cache/协议分层的作用.png" title="" alt="" data-align="center">

## 1.4 OSI 7层模型通讯

<img src="../../../image%20cache/OSI%207层模型通讯.png" title="" alt="" data-align="center">

# TCP 通讯

## 2.1 通讯流程

1. `服务器`**启动**并**绑定**到一个端口，并开始**监听**传入的连接。

2. `客户端`**创建**一个套接字，并使用此套接字**连接**到服务器的 IP 地址和端口。

3. `服务器`**接受**客户端连接，并为客户端**分配**一个新的套接字。

4. 服务器和客户端之间通过它们各自的套接字进行通信，发送和接收数据，直到一方关闭连接。

<img src="../../../image%20cache/tcp%20通讯.png" title="" alt="" data-align="center">

## 2.2 报文、帧、数据包

`应用层`：**报文**（message），一般指完整的信息，传输层实现报文交付，位于应用层的信息分组称为报文； 

`传输层`：**报文段**（segment），组成报文的每个分组；

`网络层`：**分组**（packet），网络传输中的二进制格式单元，**数据包**（datapacket）是TCP/IP 通信协议传输中的数据单位；

> 数据包，包含一个报头和数据本身，其中报头描述了数据的目的地及其与其他数据之间的关系，可以理解为数据传输的分组，我们将通过网络传输的基本数据单元称为**数据报**（Datagram）；

`链路层`：帧（frame），数据链路层的协议数据单元，为了保证数据的可靠传输，把用户数据封装成帧； 

`物理层`：**PDU**（bit），协议数据单元； 

> 抓包，抓到的是传输层的包，packet/frame/Datagram/segment是存在于同条记录中的。

### 2.2.1 tcp 报文

<img src="../../../image%20cache/TCP%20报文.png" title="" alt="" data-align="center">

### 2.2.2 IP 数据包

<img src="../../../image%20cache/IP%20数据包.png" title="" alt="" data-align="center">

#### 序号 Sequence Number

> 数据包**标记**，以便在到达目的地后重装，假设当前序列号（随机值） s，发送数据长度 l，则下次发送数据时的**序列号**为 s + l。

#### 确认号 Acknowledgemt Number

> 占 4 个字节，表示**期望收到**对方下一个报文段的序号值。

> 通讯的任何一方在收到对方的一个报文之后，都要发送一个相对应的「**确认报文**」（包含**确认号**）。 例如，通讯一方收到第一个 25kb 报文，该序号值=0，那么就需要回复一个确认报文（确认号 = 25600）。

#### 数据偏移 Offset

> 占 0.5 个字节 (4 位)。 TCP 报文段的首部长度，指出了 TCP报文段的数据起始处距离 TCP 报文的起始处。

> 一个数据偏移量 = 4 byte，由于 4 位二进制数能表示的最大十进制数字是 15，因此数据偏移的最大值是 60 byte，这也侧面限制了 TCP 首部的最大长度。

#### 保留 Reserved

> 占 0.75 个字节 (6 位)。 保留为今后使用，但目前应置为 0。

#### 标志位 TCP Flags

> 标志位，一共有 6 个，分别占 1 位，共 6 位 。 每一位的值只有 0 和 1：

- **ACK**：确认序号有效
- **RST**：重置连接
- **SYN**：发起了一个新连接
- **FIN**：释放一个连接

##### （1）确认 ACK (Acknowlegemt)

ACK = 1 时，**确认号有效**。 一般称携带 ACK 标志的 TCP 报文段为「确认报文段」。为 0 表示数据段不包含确认信息，确认号被忽略。

> TCP 规定，在连接建立后所有传送的报文段都必须把 ACK 设置为 1。

##### （2）推送 PSH (Push)

PSH = 1 时，表示该**报文段高优先级**，接收方 TCP 应该尽快推送给接收应用程序，而不用等到整个 TCP 缓存都填满了后再交付。

##### （3）复位 RST (Reset)

RST = 1 时，表示 TCP 连接中出现严重错误，需要释放并重新建立连接。 一般称携带 RST 标志的 TCP 报文段为「**复位报文段**」。

##### （4）同步 SYN (SYNchronization)

SYN = 1 时，表明这是一个**请求连接报文段**。 一般称携带 SYN 标志的 TCP 报文段为「**同步报文段**」。 在 TCP 三次握手中的第一个报文就是同步报文段，在连接建立时用来同步序号。

> 对方若同意建立连接，则应在响应的报文段中使 SYN = 1 和 ACK = 1。

##### （5）终止 FIN (Finis)

FIN = 1 时，表示此报文段的发送方的数据已经**发送完毕**，并要求释放 TCP 连接，一般称携带 FIN 的报文段为「**结束报文段**」。

> 在 TCP 四次挥手释放连接时，会用到该标志。

#### 窗口大小 Window Size

占 2 字节。指出了现在**允许对方发送的数据量**。 窗口大小的值是指，从本报文段首部中的确认号算起，接收方目前允许对方发送的数据量。

> 例如，确认号是 701 ，窗口字段是 1000。表明，从 701 号算起，发送此报文段的一方还有接收 1000 （字节序号是 701 ~ 1700） 个字节的数据的接收缓存空间。

#### 校验和 TCP Checksum

占 2 个字节。 由发送端填充，接收端对 TCP 报文段**执行 CRC 算法**，以检验 TCP 报文段在传输过程中是否损坏，如果损坏这丢弃。

> 检验范围包括首部和数据两部分，这也是 TCP 可靠传输的一个重要保障。

#### 紧急指针 Urgent Pointer

占 2 个字节。 仅在 URG = 1 时才有意义，它指出本报文段中的紧急数据的字节数。 当 URG = 1 时，发送方 TCP 就**把紧急数据插入到本报文段数据的最前面**，而在紧急数据后面的数据仍是普通数据。

> 紧急指针指出了紧急数据的末尾在报文段中的位置。

## 三次握手，四次挥手

### 三次建立连接

<img title="" src="../../../image%20cache/三次握手.png" alt="" data-align="center">

### 四次释放连接

<img src="../../../image%20cache/四次挥手.png" title="" alt="" data-align="center">
