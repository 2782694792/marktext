# CSciEngine m_engine; // 引擎对象

## 一、建立与释放

### 1、m_engine.InitEngine( )

| Description | 初始化引擎                            |
| ----------- | -------------------------------- |
| Calls       | 若要销毁引擎，调用函数 ReleaseEngine( )     |
| Others      | 初始化引擎先注册 COM ：CoInitialize(NULL) |

### 2、void ReleaseEngine

| Description | 释放引擎                  |
| ----------- | --------------------- |
| Function    | void ReleaseEngine( ) |

## 二、打开与保存

### 3、void OpenObject

| Description | 打开 sci 文件                        |
| ----------- | -------------------------------- |
| Function    | void OpenObject( LPCTSTR path )  |
| Input       | LPCTSTR：一个指向以 ‘\0’ 结尾的常量字符的指针    |
| path        | sci 文件路径及名称，如：D:\\test.sci       |
| Others      | 父窗口（parentWndHandle）大小为创建图像控件的大小 |

### 4、void SaveProject

| Description | 保存 sci 方案      |
| ----------- | -------------- |
| Others      | 相当于 sci 界面保存按钮 |

### 5、void SaveProjectAs

| Description | 保存 sci 方案文件                        |
| ----------- | ---------------------------------- |
| Function    | void SaveProjectAs( LPCTSTR path ) |
| Others      | 相当于 sci 界面另存按钮                     |

## 三、连接、运行与停止

### 6、void ConnectToWindow

| Description   | 绑定 sci 窗口                                                                         |
| ------------- | --------------------------------------------------------------------------------- |
| Function      | void ConnectToWindow( long index, __int64 windowHandle, __int64 * displayHandle ) |
| Input         | __int64: 指定一个 64 位整型变量                                                            |
| index         | sci 窗口索引                                                                          |
| wndHandle     | 父窗口句柄                                                                             |
| displayHandle | 显示句柄                                                                              |

### 7、void MoveWindow

| Description | 移动 sci 窗口到指定位置                                                              |
| ----------- | --------------------------------------------------------------------------- |
| Function    | void MoveWindow( long index, long left, long top, long right, long bottom ) |
| index       | 窗口索引                                                                        |
| left        | 左点 X                                                                        |
| top         | 左点 Y                                                                        |
| right       | 右点 X                                                                        |
| bottom      | 右点 Y                                                                        |

### 8、void Run

| Description | sci 运行开始          |
| ----------- | ----------------- |
| Others      | 该函数相当于 sci 界面运行按钮 |

### 9、void RunInLoop

| Description | sci 循环运行         |
| ----------- | ---------------- |
| Others      | 相当于 sci 界面循环运行按钮 |

### 10、void Stop

| Description | sci 停止运行       |
| ----------- | -------------- |
| Others      | 相当于 sci 界面停止按钮 |

## 四、获取算子、变量、列表

### 11、void GetBlockList

| Description | 获取 sci 中算子块名称                                |
| ----------- | -------------------------------------------- |
| Function    | void GetBlockList( LPDISPATCH * blockNames ) |
| Input       | LPDISPATCH：负责支持自动化的接口调用                      |
| blockNames  | 算子块名称列表                                      |
| others      | 需循环获取数组中的每个元素                                |

```cpp
CSciVarArray varArray; 
varArray.CreateDispatch(L"SciSmtCam.SciVarArray"); 

// 获取算子块中的数组列表（算子块列表）
m_engine.GetBlockList(&varArray.m_lpDispatch); 

int length = varArray.Length(); 
for (int i = 0; i < length; i++) 
{
    BSTR dVal; 
    varArray.GetStringByIndex(i, &dVal); 
｝
```

### 12、void GetOperatorList

| Description   | 获取某个算子块中所有算子的名称                                                       |
| ------------- | --------------------------------------------------------------------- |
| Function      | void GetOperatorList( LPCTSTR blockName, LPDISPATCH * operatorNames ) |
| Input         | LPDISPATCH：负责支持自动化的接口调用                                               |
| blockNames    | 算子块名称                                                                 |
| operatorNames | 该算子块中所有算子名称                                                           |
| others        | 需循环获取数组中的每个元素                                                         |

```cpp
CSciVarArray varArray; 
varArray.CreateDispatch(L"SciSmtCam.SciVarArray"); 

// 获取算子块中的所有算子（算子列表）
m_engine.GetOperatorList(blockname, &varArray.m_lpDispatch); 

int length = varArray.Length(); 
for (int i = 0; i < length; i++) 
{ 
    BSTR dVal; 
    varArray.GetStringByIndex(i, &dVal); 
}
```

### 13、void GetVariableList

| Description   | 获取所有变量列表                                           |
| ------------- | -------------------------------------------------- |
| Function      | void GetVariableList( LPDISPATCH * variableNames ) |
| Input         | LPDISPATCH：负责支持自动化的接口调用                            |
| variableNames | 所有变量名称列表                                           |
| others        | 需循环获取数组中的每个变量元素                                    |

```cpp
CSciVarArray varArray; 
varArray.CreateDispatch(L"SciSmtCam.SciVarArray"); 

// 获取数组中的变量列表
m_engine.GetVariableList(&varArray.m_lpDispatch); 

int length = varArray.Length(); 
for (int i = 0; i < length; i++) 
{ 
    BSTR dVal;
    varArray.GetStringByIndex(i, &dVal); 
}
```

### 14、void GetVariableNumber

| Description  | 获取 N 型变量值                                                      |
| ------------ | -------------------------------------------------------------- |
| Function     | void GetVariableNumber( LPCTSTR variableName, double * value ) |
| Input        | LPCTSTR：一个指向以 ‘\0’ 结尾的常量字符的指针                                  |
| variableName | 变量名称                                                           |
| value        | 变量值                                                            |

### 15、void GetVariablePt

| Description  | 获取 P 型变量值                                                          |
| ------------ | ------------------------------------------------------------------ |
| Function     | void GetVariablePt( LPCTSTR variableName, double * x, double * y ) |
| Input        | LPCTSTR：一个指向以 ‘\0’ 结尾的常量字符的指针                                      |
| variableName | 变量名称                                                               |
| x            | x 坐标                                                               |
| y            | y 坐标                                                               |

### 16、void GetVariableBool

| Description  | 获取 B 型变量值                                                  |
| ------------ | ---------------------------------------------------------- |
| Function     | void GetVariableBool( LPCTSTR variableName, long * value ) |
| Input        | LPCTSTR：一个指向以 ‘\0’ 结尾的常量字符的指针                              |
| variableName | 变量名称                                                       |
| value        | 变量值                                                        |

### 17、void GetVariableString

| Description  | 获取 S 型变量值                                                    |
| ------------ | ------------------------------------------------------------ |
| Function     | void GetVariableString( LPCTSTR variableName, BSTR * value ) |
| Input        | LPCTSTR：一个指向以 ‘\0’ 结尾的常量字符的指针                                |
| variableName | 变量名称                                                         |
| value        | S 变量值                                                        |

### 18、void GetVariableArray

| Description  | 获取 SCI S[ ]、N[ ]变量数据                                                   |
| ------------ | ---------------------------------------------------------------------- |
| Function     | void GetVariableArray( LPCTSTR variableName, LPDISPATCH * arrayValue ) |
| Input        | LPCTSTR：一个指向以 ‘\0’ 结尾的常量字符的指针                                          |
| variableName | 变量名称                                                                   |
| value        | 数组值                                                                    |
| Others       | 需循环获取数组中的每个变量元素                                                        |

```cpp
CSciVarArray ArrayValue; 
m_engine.GetVariableArray(variableName, &ArrayValue.m_lpDispatch);
int length = ArrayValue.Length();
for (int i = 0; i < length; i++)
{ 

 //// 提取 N[]中数据
 double dVal;
 ArrayValue.GetNumberByIndex(i, &dVal);

 /// 提取 S[]中数据
 BSTR bstrValue;
 ArrayValue.GetStringByIndex(i, &bstrValue); 
 CString StrValue = _bstr_t(bstrValue); 

 ////// 

}
```

### 19、void GetVariablePtArray

| Description     | 获取 P[ ]变量数据                                                              |
| --------------- | ------------------------------------------------------------------------ |
| Function        | void GetVariablePtArray( LPCTSTR variableName, LPDISPATCH * arrayValue ) |
| Input           | LPCTSTR：一个指向以 ‘\0’ 结尾的常量字符的指针，<br/>LPDISPATCH：负责支持自动化的接口调用               |
| variableName    | 变量名称                                                                     |
| valuearrayValue | 数组值                                                                      |
| Others          | 需循环获取数组中的每个变量元素                                                          |

```cpp
CSciPointArray ptArray;

// 获取变量点数组的信息，存入
m_engine.GetVariablePtArray(variableName, &ptArray.m_lpDispatch); 

int lengthPt = ArrayValue.Length(); 
for (int i = 0; i < lengthPt; i++) 
{ 
    double dX, dY; 
    ptArray.GetValueByIndex(i, &dX, &dY); 
}
```

## 五、窗口显示

### 20、void ShowMainWindow

| Description | 弹出显示 SCI 主窗口           |
| ----------- | ---------------------- |
| Function    | void ShowMainWindow( ) |
| Others      | 弹出后图像会在 sci 界面显示       |

### 21、void ShowSettingWindow

| Description | 显示某个算子块中算子的设置界面                                                                  |
| ----------- | -------------------------------------------------------------------------------- |
| Function    | void ShowSettingWindow( LPCTSTR blockName, LPCTSTR oprName, LPDISPATCH * image ) |
| blockName   | 算子块名称                                                                            |
| oprName     | 算子名称                                                                             |
| image       | 显示图片                                                                             |
| Others      | 调用如下 :                                                                           |

```cpp
    CSciImage img;
    img.CreateDiapatch(L"SciSmtCam.SciImage");
    // 可从外部导入图片
    // img.ReadImage(_T("d:\\1.bmp");

    /// 获取图像来源（Block1 算子块中导入图像_1 获取的图像 ）
    m_engine.GetMeasurementImage(L"结果回调", L"导入图像_1", L"Image", &img.m_lpDispatch);

    /// 显示某个 Block1 算子中参数（弹出设置界面，算法功能方可弹出）
    m_engine.ShowGettingWindow(blockName, oprName, &img.m_lpDispatch);
    img.ReleaseDispatch();
```

## 六、设置变量值

### 22、void SetVariableNumber

| Description  | 设置 N 型变量值                                                      |
| ------------ | -------------------------------------------------------------- |
| Function     | void SetVariableNumber( LPCTSTR variableName, double * value ) |
| variableName | 变量名称                                                           |
| value        | double 型变量值                                                    |

### 23、void SetVariableBool

| Description  | 设置 B 型变量值                                                                         |
| ------------ | --------------------------------------------------------------------------------- |
| Function     | void SetVariableNumber( LPCTSTR variableName, double * value )                    |
| variableName | 变量名称                                                                              |
| value        | B 型数值                                                                             |
| Others       | 设置如下：<br/>long Bvaule = 0;<br/>m_engine.SetVariableBool( variableName, &Bvaule ); |

### 24、void SetVariableString

| Description  | 设置 S 型变量值                                                                                                |
| ------------ | -------------------------------------------------------------------------------------------------------- |
| Function     | void SetVariableString( LPCTSTR variableName, LPCTSTR value )                                            |
| variableName | 变量名称                                                                                                     |
| value        | S 型数值                                                                                                    |
| Others       | 设置如下：<br/>CString temstr = _T("S 型");<br/>m_engine.SetVariableString( variableName, ( LPCTSTR )temstr ); |

## 七、设置运行位置

### 25、void SetStartBlock

| Description  | 设置局部运行开始位置                                  |
| ------------ | ------------------------------------------- |
| Function     | void SetStartBlock ( LPCTSTR variableName ) |
| variableName | 算子块名称                                       |

### 26、void SetEndBlock

| Description  | 设置局部运行结束位置                                |
| ------------ | ----------------------------------------- |
| Function     | void SetEndBlock ( LPCTSTR variableName ) |
| variableName | 算子块名称                                     |

### 27、void SetRunOnceBlock

| Description  | 设置单个算子块运行位置                                  |
| ------------ | -------------------------------------------- |
| Function     | void SetRunOnceBlock( LPCTSTR variableName ) |
| variableName | 算子块名称                                        |

### 28、void PartRun

| Description | 局部运行，包涵了单个算子块运行功能。                                                |
| ----------- | ----------------------------------------------------------------- |
| Function    | void PartRun( )                                                   |
| Others      | PartRun 配合 SetStartBlock 与 SetEndBlock 使用，也可配合 SetRunOnceBlock 使用 |

## 八、注销、回调

### 29、void EnableOperatorEvent

| Description  | 注册某个算子块中的算子运行结束后进行回调                                                              |
| ------------ | --------------------------------------------------------------------------------- |
| Function     | void EnableOperatorEvent( LPCTSTR blockName, LPCTSTR operatorName, long eventID ) |
| Calls        | 如果要注销，调用函数 DisableOperatorEvent( )                                                |
| blockName    | 算子块名称                                                                             |
| operatorName | 算子名称                                                                              |
| eventID      | 事件 ID : SCICAM_OPR_RUN_START-算子开始,<br/>            SCICAM_OPR_RUN_START-算子结束      |

### 30、void DisableOperatorEvent

| Description  | 注销某个算子块中的算子回调                                                                      |
| ------------ | ---------------------------------------------------------------------------------- |
| Function     | void DisableOperatorEvent( LPCTSTR blockName, LPCTSTR operatorName, long eventID ) |
| blockName    | 算子块名称                                                                              |
| operatorName | 算子名称                                                                               |
| eventID      | 事件 ID : SCICAM_OPR_RUN_START-算子开始,<br/>            SCICAM_OPR_RUN_START-算子结束       |

### 31、回调函数

```cpp
virtual STDMETHODIMP OnAppStrart();
virtual STDMETHODIMP OnAppEnd();
virtual STDMETHODIMP OnOperatorStart(_bstr_t blockName, _bstr_t oprName);
virtual STDMETHODIMP OnOperatorEnd(_bstr_t blockName, _bstr_t oprName);
```

#### 31.1 是否处于运行模式

```cpp
//点击开始运行按钮进入该函数-可以用来判断软件是否是运行模式下 
STDMETHODIMP CSciEngineTestDlg::OnAppStart() 
{ 
    b_RunIng = true; 
    return S_OK; 
}
```

#### 31.2 是否处于停止模式

```cpp
//点击停止按钮进入该函数 -可以用来判断软件是否是提停止模式下 
STDMETHODIMP CSciEngineTestDlg::OnAppEnd() 
{ 
    b_RunIng = false; 
    return S_OK; 
}
```

#### 31.3 算子开始前进入回调

```cpp
///当 SCI 运行到 blockName 某个算子块中的某个算子开始前
///    进入此回调函数-前提先注册回调函数 EnableOperatorEvent
STDMETHODIMP 
    CSciEngineTestDlg::OnOperatorStart(_bstr_t blockName, _bstr_t oprName) 
{ 
    return S_OK; 
}
```

#### 31.4 算子结束后进入回调

```cpp
///当 SCI 运行到 blockName 某个算子块中的某个算子结束后
///    进入此回调函数-前提先注册回调函数 EnableOperatorEvent
STDMETHODIMP 
    CSciEngineTestDlg::OnOperatorEnd(_bstr_t blockName, _bstr_t oprName) 
{ 
    return S_OK; 
}
```

## 九、获取运行数据

### 32、void GetWindowCount

| Description | 获取 SCI 窗口数量                             |
| ----------- | --------------------------------------- |
| Function    | void GetWindowCount(long * windowCount) |
| windowCount | 窗口数                                     |

### 33、void GetMeasurementImage

| Description | 获取某个图像算子块中某个算子的图像变量                                                                                 |
| ----------- | --------------------------------------------------------------------------------------------------- |
| Function    | void GetMeasurementImage( LPCTSTR blockName, LPCTSTR oprName, LPCTSTR varName, LPDISPATCH * value ) |
| blockName   | 算子块名称                                                                                               |
| oprName     | 算子名称                                                                                                |
| varName     | 图像类型： Image、ImageRotated、ImageMirrored 根据 sci 算子块输出的类型选择                                            |
| value       | 图像数据                                                                                                |
| Others      | 调用如下 :                                                                                              |

```cpp
CSciImage img;
img.CreateDiapatch(L"SciSmtCam.SciImage");

// 获取图像来源（Block1 算子块中导入图像_1 获取的图像 ）
m_engine.GetMeasurementImage(L"结果回调", L"导入图像_1", L"Image"
    , &img.m_lpDispatch);
```
